name: benchmarkoor

on:
  workflow_dispatch:
    inputs:
      client:
        description: "Ethereum execution client to benchmark"
        required: false
        default: "geth"
      snapshot:
        description: "Snapshot path (network/block)"
        required: false
        type: choice
        options:
          - "mainnet/24350000"
          - "perf-devnet-2/24350000"
      test-type:
        description: "Test type to run"
        required: false
        type: choice
        options:
          - "stateful"
          - "compute"
        default: "stateful"
      run-timeout-minutes:
        description: "Timeout for the benchmark run (minutes)"
        required: false
        default: "210"
      image:
        description: "Benchmarkoor docker image"
        required: false
        default: "ghcr.io/ethpandaops/benchmarkoor:master"
      git-ref:
        description: "Git reference to checkout for benchmarkoor"
        required: false
        default: ""
      upload-artifacts:
        description: "Upload run results as GitHub artifacts"
        required: false
        default: "false"

jobs:
  benchmarkoor:
    runs-on:
      group: gasbenchmark
      labels: snapshot-${{ inputs.client }}
    timeout-minutes: ${{ fromJSON(inputs.run-timeout-minutes) }}
    steps:
      - uses: actions/checkout@v4

      - uses: ethpandaops/benchmarkoor@master
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          image: ${{ inputs.image }}
          git-ref: ${{ inputs.git-ref }}
          upload-artifacts: ${{ inputs.upload-artifacts }}
          run-config-urls: >-
            configs/global.yaml,
            configs/resource-limits-eip-7870-fullnode.yaml,
            configs/repricings/${{ inputs.snapshot }}/datadir-snapshots.yaml,
            configs/repricings/${{ inputs.snapshot }}/test-source-${{ inputs.test-type }}.yaml,
            configs/repricings/${{ inputs.snapshot }}/clients.yaml
          run-args: --limit-instance-client=${{ inputs.client }}
